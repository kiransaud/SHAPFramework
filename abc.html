<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SHAP Bug Localization Study</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 20px;
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .header {
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: white;
      padding: 30px;
      text-align: center;
      border-radius: 20px 20px 0 0;
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
      background-size: cover;
    }
    
    .header h1 {
      font-size: 2.8rem;
      margin-bottom: 10px;
      position: relative;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
      max-width: 800px;
      margin: 0 auto;
      position: relative;
    }
    
    .content {
      padding: 30px;
    }
    
    .scenario-selector {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .scenario-btn {
      padding: 14px 25px;
      border: none;
      background: linear-gradient(to right, #4b6cb7, #182848);
      color: white;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .scenario-btn.active {
      background: linear-gradient(to right, #ff8c00, #ff2d00);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(255, 140, 0, 0.4);
    }
    
    .scenario-btn i {
      font-size: 1.2rem;
    }
    
    .prediction-box {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin: 25px 0;
      text-align: center;
      font-size: 1.2rem;
      box-shadow: 0 5px 15px rgba(238, 90, 82, 0.3);
      position: relative;
      overflow: hidden;
      border-left: 5px solid #c0392b;
    }
    
    .explanation-panel {
      background: rgba(245, 247, 250, 0.95);
      padding: 25px;
      border-radius: 15px;
      margin: 25px 0;
      border-left: 5px solid #3498db;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .feature-explanation {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
      border-left: 5px solid #f39c12;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    
    .code-container {
      background: #1e1e1e;
      border-radius: 15px;
      overflow: hidden;
      margin: 25px 0;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid #444;
    }
    
    .code-header {
      background: #2d2d2d;
      padding: 15px 25px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Fira Code', Consolas, monospace;
      border-bottom: 1px solid #444;
    }
    
    .code {
      color: #f8f8f2;
      padding: 0;
      font-family: 'Fira Code', Consolas, monospace;
      font-size: 15px;
      line-height: 1.8;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .code-line {
      padding: 8px 25px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 4px solid transparent;
      display: flex;
      position: relative;
    }
    
    .code-line:hover {
      background: rgba(255, 255, 255, 0.07);
      border-left-color: #2ecc71;
    }
    
    .lineno {
      display: inline-block;
      width: 40px;
      color: #75715e;
      user-select: none;
      margin-right: 20px;
      font-size: 14px;
      text-align: right;
    }
    
    .selected {
      background: rgba(46, 204, 113, 0.15) !important;
      border-left-color: #2ecc71 !important;
    }
    
    .shap-overlay {
      position: relative;
    }
    
    .shap-value {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 4px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: 600;
      display: none;
      font-family: 'Fira Code', Consolas, monospace;
      min-width: 45px;
      text-align: center;
    }
    
    .shap-methodology {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      padding: 25px;
      border-radius: 12px;
      margin: 20px 0;
      border-left: 5px solid #2980b9;
    }
    
    .accuracy-indicator {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .high-accuracy {
      background: #27ae60;
      color: white;
    }
    
    .medium-accuracy {
      background: #f39c12;
      color: white;
    }
    
    .low-accuracy {
      background: #e74c3c;
      color: white;
    }
    
    .btn {
      padding: 14px 35px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-right: 15px;
      font-size: 1.1rem;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    
    .btn-primary {
      background: linear-gradient(to right, #3498db, #2980b9);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(to right, #2ecc71, #27ae60);
      color: white;
    }
    
    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    .btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(0,0,0,0.2);
    }
    
    .results {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin: 30px 0;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }
    
    .export-section {
      margin-top: 30px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .scenario {
      display: none;
    }
    
    .scenario.active {
      display: block;
    }
    
    .comparison-panel {
      background: #e3f2fd;
      padding: 25px;
      border-radius: 15px;
      margin: 30px 0 20px;
      border: 2px dashed #3498db;
    }
    
    .comparison-row {
      display: flex;
      gap: 25px;
      margin-top: 20px;
    }
    
    .comparison-card {
      flex: 1;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transition: transform 0.3s ease;
    }
    
    .comparison-card:hover {
      transform: translateY(-5px);
    }
    
    .comparison-card h4 {
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
    }
    
    .metric {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #eee;
    }
    
    .metric-value {
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    .insight-prompt {
      background: #fffde7;
      padding: 25px;
      border-radius: 12px;
      margin: 25px 0;
      border-left: 5px solid #ffc107;
    }
    
    .insight-prompt textarea {
      width: 100%;
      height: 120px;
      padding: 15px;
      margin-top: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
    }
    
    .progress-container {
      height: 8px;
      background: #ecf0f1;
      border-radius: 4px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(to right, #3498db, #2ecc71);
      width: 25%;
      transition: width 0.5s ease;
    }
    
    .stats-row {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      flex: 1;
      min-width: 200px;
      text-align: center;
    }
    
    .stat-card h3 {
      color: #3498db;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 2.5rem;
      font-weight: bold;
      color: #2c3e50;
    }
    
    .stat-card .label {
      color: #7f8c8d;
      font-size: 1rem;
    }
    
    .shap-value[data-value="high"] { color: #ff6b6b; font-weight: bold; }
    .shap-value[data-value="medium"] { color: #f39c12; }
    .shap-value[data-value="low"] { color: #2ecc71; }
    
    .show-shap .shap-value {
      display: block;
    }
    
    .shap-visualization {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin: 25px 0;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .shap-header {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .shap-graph-container {
      height: 400px;
      margin-bottom: 20px;
    }
    
    .shap-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    
    .shap-tab {
      padding: 10px 20px;
      background: #e3f2fd;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .shap-tab.active {
      background: #3498db;
      color: white;
    }
    
    .shap-explanation {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #3498db;
    }
    
    @media (max-width: 768px) {
      .comparison-row {
        flex-direction: column;
      }
      
      .header h1 {
        font-size: 2.2rem;
      }
      
      .scenario-selector {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 10px;
        justify-content: center;
      }
      
      .shap-graph-container {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-bug"></i> SHAP Bug Localization Study</h1>
      <p>Measuring how SHAP explanations improve developer understanding of software defects</p>
    </div>

    <div class="content">
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      
      <div class="scenario-selector">
        <button class="scenario-btn active" data-scenario="1" onclick="loadScenario(1)">
          <i class="fas fa-memory"></i> Memory Leak
        </button>
        <button class="scenario-btn" data-scenario="2" onclick="loadScenario(2)">
          <i class="fas fa-running"></i> Race Condition
        </button>
        <button class="scenario-btn" data-scenario="3" onclick="loadScenario(3)">
          <i class="fas fa-shield-alt"></i> SQL Injection
        </button>
        <button class="scenario-btn" data-scenario="4" onclick="loadScenario(4)">
          <i class="fas fa-brain"></i> Logic Error
        </button>
      </div>

      <!-- Scenario 1: Memory Leak -->
      <div id="scenario1" class="scenario active">
        <div class="prediction-box">
          <i class="fas fa-exclamation-triangle"></i> Static Analysis Tool: HIGH RISK - Potential memory leak detected (Confidence: 78%)
        </div>

        <div class="explanation-panel">
          <h3><i class="fas fa-info-circle"></i> Context</h3>
          <p>This file processing utility has been causing memory issues in production. The application gradually consumes more memory over time when processing large batches of files.</p>
        </div>

        <div class="code-container">
          <div class="code-header">
            <span>file_processor.py</span>
            <span>45 lines</span>
          </div>
          <div class="code" id="code1">
            <div class="code-line" data-lineno="1"><span class="lineno">1</span>import os<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="2"><span class="lineno">2</span>import json<span class="shap-value" data-value="low">0.05</span></div>
            <div class="code-line" data-lineno="3"><span class="lineno">3</span>import logging<span class="shap-value" data-value="low">0.01</span></div>
            <div class="code-line" data-lineno="4"><span class="lineno">4</span>from typing import List, Dict, Optional<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="5"><span class="lineno">5</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="6"><span class="lineno">6</span>class FileProcessor:<span class="shap-value" data-value="low">0.08</span></div>
            <div class="code-line" data-lineno="7"><span class="lineno">7</span>    def __init__(self, max_cache_size: int = 1000):<span class="shap-value" data-value="medium">0.15</span></div>
            <div class="code-line" data-lineno="8"><span class="lineno">8</span>        self.cache = {}<span class="shap-value" data-value="high">0.45</span></div>
            <div class="code-line" data-lineno="9"><span class="lineno">9</span>        self.max_cache_size = max_cache_size<span class="shap-value" data-value="medium">0.12</span></div>
            <div class="code-line" data-lineno="10"><span class="lineno">10</span>        self.processed_files = []<span class="shap-value" data-value="medium">0.25</span></div>
            <div class="code-line" data-lineno="11"><span class="lineno">11</span>        self.logger = logging.getLogger(__name__)<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="12"><span class="lineno">12</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="13"><span class="lineno">13</span>    def process_file(self, filepath: str) -> Optional[Dict]:<span class="shap-value" data-value="low">0.06</span></div>
            <div class="code-line" data-lineno="14"><span class="lineno">14</span>        """Process a single file and return parsed data."""<span class="shap-value" data-value="low">0.01</span></div>
            <div class="code-line" data-lineno="15"><span class="lineno">15</span>        if filepath in self.cache:<span class="shap-value" data-value="medium">0.18</span></div>
            <div class="code-line" data-lineno="16"><span class="lineno">16</span>            return self.cache[filepath]<span class="shap-value" data-value="low">0.09</span></div>
            <div class="code-line" data-lineno="17"><span class="lineno">17</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="18"><span class="lineno">18</span>        try:<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="19"><span class="lineno">19</span>            with open(filepath, 'r') as file:<span class="shap-value" data-value="low">0.07</span></div>
            <div class="code-line" data-lineno="20"><span class="lineno">20</span>                content = file.read()<span class="shap-value" data-value="low">0.05</span></div>
            <div class="code-line" data-lineno="21"><span class="lineno">21</span>                data = json.loads(content)<span class="shap-value" data-value="low">0.06</span></div>
            <div class="code-line" data-lineno="22"><span class="lineno">22</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="23"><span class="lineno">23</span>                # Process and transform data<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="24"><span class="lineno">24</span>                processed_data = self._transform_data(data)<span class="shap-value" data-value="medium">0.11</span></div>
            <div class="code-line" data-lineno="25"><span class="lineno">25</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="26"><span class="lineno">26</span>                # Cache the result<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="27"><span class="lineno">27</span>                self.cache[filepath] = processed_data<span class="shap-value" data-value="high">0.62</span></div>
            <div class="code-line" data-lineno="28"><span class="lineno">28</span>                self.processed_files.append(filepath)<span class="shap-value" data-value="high">0.38</span></div>
            <div class="code-line" data-lineno="29"><span class="lineno">29</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="30"><span class="lineno">30</span>                return processed_data<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="31"><span class="lineno">31</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="32"><span class="lineno">32</span>        except FileNotFoundError:<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="33"><span class="lineno">33</span>            self.logger.error(f"File not found: {filepath}")<span class="shap-value" data-value="low">0.01</span></div>
            <div class="code-line" data-lineno="34"><span class="lineno">34</span>            return None<span class="shap-value" data-value="low">0.01</span></div>
            <div class="code-line" data-lineno="35"><span class="lineno">35</span>        except json.JSONDecodeError as e:<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="36"><span class="lineno">36</span>            self.logger.error(f"Invalid JSON in {filepath}: {e}")<span class="shap-value" data-value="low">0.01</span></div>
            <div class="code-line" data-lineno="37"><span class="lineno">37</span>            return None<span class="shap-value" data-value="low">0.01</span></div>
            <div class="code-line" data-lineno="38"><span class="lineno">38</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="39"><span class="lineno">39</span>    def _transform_data(self, data: Dict) -> Dict:<span class="shap-value" data-value="low">0.08</span></div>
            <div class="code-line" data-lineno="40"><span class="lineno">40</span>        """Transform raw data into processed format."""<span class="shap-value" data-value="low">0.01</span></div>
            <div class="code-line" data-lineno="41"><span class="lineno">41</span>        # Expensive computation that creates large objects<span class="shap-value" data-value="low">0.09</span></div>
            <div class="code-line" data-lineno="42"><span class="lineno">42</span>        transformed = {**data}<span class="shap-value" data-value="low">0.06</span></div>
            <div class="code-line" data-lineno="43"><span class="lineno">43</span>        transformed['metadata'] = self._generate_metadata(data)<span class="shap-value" data-value="medium">0.13</span></div>
            <div class="code-line" data-lineno="44"><span class="lineno">44</span>        return transformed<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="45"><span class="lineno">45</span><span class="shap-value" data-value="low">0.00</span></div>
          </div>
        </div>

        <div id="shapExplanation1" style="display:none;">
          <div class="shap-methodology">
            <h3><i class="fas fa-brain"></i> How SHAP Analysis Works</h3>
            <p><strong>SHAP (SHapley Additive exPlanations)</strong> explains individual predictions by computing the contribution of each feature (code line) to the final prediction. The values show how much each line increases or decreases the probability of a memory leak.</p>
            <ul>
              <li><strong>Training Data:</strong> 10,000+ code samples with known memory leak patterns</li>
              <li><strong>Features Analyzed:</strong> Variable assignments, data structures, loop patterns, cache operations</li>
              <li><strong>Base Model:</strong> Random Forest trained on static analysis features</li>
              <li><strong>SHAP Method:</strong> TreeExplainer for fast, exact attributions</li>
            </ul>
          </div>

          <!-- SHAP Visualization -->
          <div class="shap-visualization">
            <div class="shap-header">
              <h3><i class="fas fa-chart-bar"></i> SHAP Feature Attribution Analysis</h3>
            </div>
            
            <div class="shap-tabs">
              <div class="shap-tab active" onclick="showShapTab(1, 'force')">Force Plot</div>
              <div class="shap-tab" onclick="showShapTab(1, 'waterfall')">Waterfall</div>
              <div class="shap-tab" onclick="showShapTab(1, 'summary')">Summary</div>
            </div>
            
            <div id="shapForcePlot1" class="shap-graph-container"></div>
            <div id="shapWaterfallPlot1" class="shap-graph-container" style="display:none;"></div>
            <div id="shapSummaryPlot1" class="shap-graph-container" style="display:none;"></div>
            
            <div class="shap-explanation">
              <p><strong>Interpretation:</strong> The force plot shows how each feature (code line) contributes to pushing the model output from the base value to the final prediction. Positive values (red) increase the risk prediction, while negative values (blue) decrease it.</p>
            </div>
          </div>

          <div class="feature-explanation">
            <h4><i class="fas fa-search"></i> Key Risk Indicators Detected:</h4>
            <ul>
              <li><strong>Line 27 (0.62):</strong> <span class="accuracy-indicator high-accuracy">HIGH IMPACT</span> Cache assignment without bounds checking - primary leak source</li>
              <li><strong>Line 8 (0.45):</strong> <span class="accuracy-indicator high-accuracy">HIGH IMPACT</span> Unbounded dictionary initialization enables unlimited growth</li>
              <li><strong>Line 28 (0.38):</strong> <span class="accuracy-indicator medium-accuracy">MEDIUM IMPACT</span> List accumulation without cleanup mechanism</li>
              <li><strong>Line 10 (0.25):</strong> <span class="accuracy-indicator medium-accuracy">MEDIUM IMPACT</span> Another unbounded collection that grows indefinitely</li>
              <li><strong>Line 15 (0.18):</strong> <span class="accuracy-indicator low-accuracy">LOW IMPACT</span> Cache lookup pattern (normal operation)</li>
            </ul>
            <p><em>Note: Values represent SHAP attribution scores. Higher values indicate stronger contribution to memory leak prediction.</em></p>
          </div>

          <div class="comparison-panel">
            <h3><i class="fas fa-chart-bar"></i> Developer vs. SHAP Comparison</h3>
            <div class="comparison-row">
              <div class="comparison-card">
                <h4><i class="fas fa-user"></i> Your Initial Assessment</h4>
                <div class="metric">
                  <span>Lines selected:</span>
                  <span class="metric-value" id="preShapLines1">0</span>
                </div>
                <div class="metric">
                  <span>Correct lines:</span>
                  <span class="metric-value" id="preShapCorrect1">0</span>
                </div>
                <div class="metric">
                  <span>Accuracy:</span>
                  <span class="metric-value" id="preShapAccuracy1">0%</span>
                </div>
                <div class="metric">
                  <span>Time taken:</span>
                  <span class="metric-value" id="preShapTime1">0s</span>
                </div>
              </div>
              <div class="comparison-card">
                <h4><i class="fas fa-robot"></i> SHAP Analysis</h4>
                <div class="metric">
                  <span>Critical lines:</span>
                  <span class="metric-value">3</span>
                </div>
                <div class="metric">
                  <span>Overlap with your selection:</span>
                  <span class="metric-value" id="shapOverlap1">0</span>
                </div>
                <div class="metric">
                  <span>Missed critical lines:</span>
                  <span class="metric-value" id="shapMissed1">3</span>
                </div>
                <div class="metric">
                  <span>Average SHAP value:</span>
                  <span class="metric-value" id="shapAvg1">0.00</span>
                </div>
              </div>
            </div>
          </div>

          <div class="insight-prompt">
            <h4><i class="fas fa-lightbulb"></i> Your "Aha!" Moment</h4>
            <p>Did SHAP reveal lines you didn't consider? How did it change your understanding of this bug?</p>
            <textarea id="insight1" placeholder="Write your observations here..."></textarea>
          </div>
        </div>

        <div class="explanation-panel">
          <h3><i class="fas fa-tasks"></i> Your Task</h3>
          <p>Click on the line(s) you believe are most responsible for the memory leak issue. You can select up to 3 lines.</p>
          <div style="margin:15px 0;">
            <span style="background:#4CAF50;color:white;padding:6px 14px;border-radius:20px;font-size:14px;font-weight:bold;">
              <i class="fas fa-check-circle"></i> Selected: <span id="selectedCount1">0</span>/3
            </span>
          </div>
        </div>

        <div style="margin-top: 30px; text-align: center;">
          <button class="btn btn-primary" id="showShapBtn1">
            <i class="fas fa-chart-line"></i> Show SHAP Analysis
          </button>
          <button class="btn btn-success" id="nextScenarioBtn1" style="display:none;" onclick="loadScenario(2)">
            <i class="fas fa-arrow-right"></i> Next Scenario
          </button>
        </div>
      </div>

      <!-- Scenario 2: Race Condition -->
      <div id="scenario2" class="scenario" style="display:none;">
        <div class="prediction-box">
          <i class="fas fa-exclamation-triangle"></i> Concurrency Analyzer: MEDIUM RISK - Race condition detected (Confidence: 65%)
        </div>

        <div class="explanation-panel">
          <h3><i class="fas fa-info-circle"></i> Context</h3>
          <p>This user session manager occasionally corrupts data when multiple requests access the same user session simultaneously. The issue manifests as inconsistent user state and authentication failures.</p>
        </div>

        <div class="code-container">
          <div class="code-header">
            <span>session_manager.py</span>
            <span>38 lines</span>
          </div>
          <div class="code" id="code2">
            <div class="code-line" data-lineno="1"><span class="lineno">1</span>import time<span class="shap-value" data-value="low">0.05</span></div>
            <div class="code-line" data-lineno="2"><span class="lineno">2</span>import threading<span class="shap-value" data-value="medium">0.12</span></div>
            <div class="code-line" data-lineno="3"><span class="lineno">3</span>from typing import Dict, Optional<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="4"><span class="lineno">4</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="5"><span class="lineno">5</span>class SessionManager:<span class="shap-value" data-value="low">0.08</span></div>
            <div class="code-line" data-lineno="6"><span class="lineno">6</span>    def __init__(self):<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="7"><span class="lineno">7</span>        self.sessions = {}<span class="shap-value" data-value="high">0.31</span></div>
            <div class="code-line" data-lineno="8"><span class="lineno">8</span>        self.last_cleanup = time.time()<span class="shap-value" data-value="medium">0.09</span></div>
            <div class="code-line" data-lineno="9"><span class="lineno">9</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="10"><span class="lineno">10</span>    def get_session(self, user_id: str) -> Optional[Dict]:<span class="shap-value" data-value="medium">0.15</span></div>
            <div class="code-line" data-lineno="11"><span class="lineno">11</span>        """Get user session, create if doesn't exist."""<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="12"><span class="lineno">12</span>        if user_id not in self.sessions:<span class="shap-value" data-value="high">0.41</span></div>
            <div class="code-line" data-lineno="13"><span class="lineno">13</span>            self.sessions[user_id] = {<span class="shap-value" data-value="high">0.52</span></div>
            <div class="code-line" data-lineno="14"><span class="lineno">14</span>                'created': time.time(),<span class="shap-value" data-value="medium">0.18</span></div>
            <div class="code-line" data-lineno="15"><span class="lineno">15</span>                'last_access': time.time(),<span class="shap-value" data-value="medium">0.16</span></div>
            <div class="code-line" data-lineno="16"><span class="lineno">16</span>                'data': {}<span class="shap-value" data-value="medium">0.13</span></div>
            <div class="code-line" data-lineno="17"><span class="lineno">17</span>            }<span class="shap-value" data-value="low">0.08</span></div>
            <div class="code-line" data-lineno="18"><span class="lineno">18</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="19"><span class="lineno">19</span>        self.sessions[user_id]['last_access'] = time.time()<span class="shap-value" data-value="high">0.45</span></div>
            <div class="code-line" data-lineno="20"><span class="lineno">20</span>        return self.sessions[user_id]<span class="shap-value" data-value="medium">0.22</span></div>
            <div class="code-line" data-lineno="21"><span class="lineno">21</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="22"><span class="lineno">22</span>    def update_session(self, user_id: str, data: Dict) -> bool:<span class="shap-value" data-value="medium">0.19</span></div>
            <div class="code-line" data-lineno="23"><span class="lineno">23</span>        """Update session data for user."""<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="24"><span class="lineno">24</span>        if user_id in self.sessions:<span class="shap-value" data-value="medium">0.28</span></div>
            <div class="code-line" data-lineno="25"><span class="lineno">25</span>            current_data = self.sessions[user_id]['data']<span class="shap-value" data-value="medium">0.35</span></div>
            <div class="code-line" data-lineno="26"><span class="lineno">26</span>            current_data.update(data)<span class="shap-value" data-value="high">0.48</span></div>
            <div class="code-line" data-lineno="27"><span class="lineno">27</span>            self.sessions[user_id]['last_access'] = time.time()<span class="shap-value" data-value="medium">0.33</span></div>
            <div class="code-line" data-lineno="28"><span class="lineno">28</span>            return True<span class="shap-value" data-value="low">0.06</span></div>
            <div class="code-line" data-lineno="29"><span class="lineno">29</span>        return False<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="30"><span class="lineno">30</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="31"><span class="lineno">31</span>    def cleanup_expired(self, max_age: int = 3600):<span class="shap-value" data-value="medium">0.11</span></div>
            <div class="code-line" data-lineno="32"><span class="lineno">32</span>        """Remove expired sessions."""<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="33"><span class="lineno">33</span>        current_time = time.time()<span class="shap-value" data-value="low">0.07</span></div>
            <div class="code-line" data-lineno="34"><span class="lineno">34</span>        expired_users = [uid for uid, session in self.sessions.items()<span class="shap-value" data-value="medium">0.25</span></div>
            <div class="code-line" data-lineno="35"><span class="lineno">35</span>                        if current_time - session['last_access'] > max_age]<span class="shap-value" data-value="medium">0.18</span></div>
            <div class="code-line" data-lineno="36"><span class="lineno">36</span>        for uid in expired_users:<span class="shap-value" data-value="medium">0.14</span></div>
            <div class="code-line" data-lineno="37"><span class="lineno">37</span>            del self.sessions[uid]<span class="shap-value" data-value="medium">0.29</span></div>
            <div class="code-line" data-lineno="38"><span class="lineno">38</span>        self.last_cleanup = current_time<span class="shap-value" data-value="low">0.08</span></div>
          </div>
        </div>

        <div id="shapExplanation2" style="display:none;">
          <div class="shap-methodology">
            <h3><i class="fas fa-brain"></i> How SHAP Detected This Race Condition</h3>
            <p><strong>Concurrency Pattern Recognition:</strong> The model was trained on threading issues and identifies read-modify-write operations without synchronization as high-risk patterns.</p>
            <ul>
              <li><strong>Training Focus:</strong> Multi-threaded code patterns, shared resource access</li>
              <li><strong>Key Indicators:</strong> Non-atomic operations on shared state, missing locks</li>
              <li><strong>Detection Method:</strong> Static analysis of concurrent access patterns</li>
            </ul>
          </div>

          <!-- SHAP Visualization -->
          <div class="shap-visualization">
            <div class="shap-header">
              <h3><i class="fas fa-chart-bar"></i> Race Condition Risk Analysis</h3>
            </div>
            
            <div class="shap-tabs">
              <div class="shap-tab active" onclick="showShapTab(2, 'force')">Force Plot</div>
              <div class="shap-tab" onclick="showShapTab(2, 'waterfall')">Waterfall</div>
              <div class="shap-tab" onclick="showShapTab(2, 'summary')">Summary</div>
            </div>
            
            <div id="shapForcePlot2" class="shap-graph-container"></div>
            <div id="shapWaterfallPlot2" class="shap-graph-container" style="display:none;"></div>
            <div id="shapSummaryPlot2" class="shap-graph-container" style="display:none;"></div>
            
            <div class="shap-explanation">
              <p><strong>Interpretation:</strong> The force plot shows how each code line contributes to the race condition risk. Red bars indicate code that increases the risk, while blue bars indicate protective patterns.</p>
            </div>
          </div>

          <div class="feature-explanation">
            <h4><i class="fas fa-search"></i> Critical Race Condition Points:</h4>
            <ul>
              <li><strong>Line 13 (0.52):</strong> <span class="accuracy-indicator high-accuracy">CRITICAL</span> Non-atomic session creation allows duplicate creation</li>
              <li><strong>Line 26 (0.48):</strong> <span class="accuracy-indicator high-accuracy">HIGH RISK</span> Dictionary update without locking can lose data</li>
              <li><strong>Line 19 (0.45):</strong> <span class="accuracy-indicator high-accuracy">HIGH RISK</span> Timestamp update race condition</li>
              <li><strong>Line 12 (0.41):</strong> <span class="accuracy-indicator medium-accuracy">MEDIUM RISK</span> Check-then-act race window</li>
              <li><strong>Line 25 (0.35):</strong> <span class="accuracy-indicator medium-accuracy">MEDIUM RISK</span> Read operation in unsafe context</li>
            </ul>
          </div>

          <div class="comparison-panel">
            <h3><i class="fas fa-chart-bar"></i> Developer vs. SHAP Comparison</h3>
            <div class="comparison-row">
              <div class="comparison-card">
                <h4><i class="fas fa-user"></i> Your Initial Assessment</h4>
                <div class="metric">
                  <span>Lines selected:</span>
                  <span class="metric-value" id="preShapLines2">0</span>
                </div>
                <div class="metric">
                  <span>Correct lines:</span>
                  <span class="metric-value" id="preShapCorrect2">0</span>
                </div>
                <div class="metric">
                  <span>Accuracy:</span>
                  <span class="metric-value" id="preShapAccuracy2">0%</span>
                </div>
                <div class="metric">
                  <span>Time taken:</span>
                  <span class="metric-value" id="preShapTime2">0s</span>
                </div>
              </div>
              <div class="comparison-card">
                <h4><i class="fas fa-robot"></i> SHAP Analysis</h4>
                <div class="metric">
                  <span>Critical lines:</span>
                  <span class="metric-value">3</span>
                </div>
                <div class="metric">
                  <span>Overlap with your selection:</span>
                  <span class="metric-value" id="shapOverlap2">0</span>
                </div>
                <div class="metric">
                  <span>Missed critical lines:</span>
                  <span class="metric-value" id="shapMissed2">3</span>
                </div>
                <div class="metric">
                  <span>Average SHAP value:</span>
                  <span class="metric-value" id="shapAvg2">0.00</span>
                </div>
              </div>
            </div>
          </div>

          <div class="insight-prompt">
            <h4><i class="fas fa-lightbulb"></i> Your "Aha!" Moment</h4>
            <p>Did SHAP reveal lines you didn't consider? How did it change your understanding of this bug?</p>
            <textarea id="insight2" placeholder="Write your observations here..."></textarea>
          </div>
        </div>

        <div class="explanation-panel">
          <h3><i class="fas fa-tasks"></i> Your Task</h3>
          <p>Click on the line(s) you believe are most responsible for the race condition. You can select up to 3 lines.</p>
          <div style="margin:15px 0;">
            <span style="background:#4CAF50;color:white;padding:6px 14px;border-radius:20px;font-size:14px;font-weight:bold;">
              <i class="fas fa-check-circle"></i> Selected: <span id="selectedCount2">0</span>/3
            </span>
          </div>
        </div>

        <div style="margin-top: 30px; text-align: center;">
          <button class="btn btn-primary" id="showShapBtn2">
            <i class="fas fa-chart-line"></i> Show SHAP Analysis
          </button>
          <button class="btn btn-success" id="nextScenarioBtn2" style="display:none;" onclick="loadScenario(3)">
            <i class="fas fa-arrow-right"></i> Next Scenario
          </button>
        </div>
      </div>

      <!-- Scenario 3: SQL Injection -->
      <div id="scenario3" class="scenario" style="display:none;">
        <div class="prediction-box">
          <i class="fas fa-shield-alt"></i> Security Scanner: HIGH RISK - SQL Injection vulnerability (Confidence: 84%)
        </div>

        <div class="explanation-panel">
          <h3><i class="fas fa-info-circle"></i> Context</h3>
          <p>This user authentication system has been flagged by security scanners. Penetration testing revealed that malicious users can potentially bypass authentication or access unauthorized data through crafted input.</p>
        </div>

        <div class="code-container">
          <div class="code-header">
            <span>auth_service.py</span>
            <span>42 lines</span>
          </div>
          <div class="code" id="code3">
            <div class="code-line" data-lineno="1"><span class="lineno">1</span>import sqlite3<span class="shap-value" data-value="medium">0.18</span></div>
            <div class="code-line" data-lineno="2"><span class="lineno">2</span>import hashlib<span class="shap-value" data-value="low">0.08</span></div>
            <div class="code-line" data-lineno="3"><span class="lineno">3</span>import logging<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="4"><span class="lineno">4</span>from typing import Optional, Dict<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="5"><span class="lineno">5</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="6"><span class="lineno">6</span>class AuthService:<span class="shap-value" data-value="low">0.05</span></div>
            <div class="code-line" data-lineno="7"><span class="lineno">7</span>    def __init__(self, db_path: str):<span class="shap-value" data-value="low">0.06</span></div>
            <div class="code-line" data-lineno="8"><span class="lineno">8</span>        self.db_path = db_path<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="9"><span class="lineno">9</span>        self.logger = logging.getLogger(__name__)<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="10"><span class="lineno">10</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="11"><span class="lineno">11</span>    def authenticate_user(self, username: str, password: str) -> Optional[Dict]:<span class="shap-value" data-value="medium">0.12</span></div>
            <div class="code-line" data-lineno="12"><span class="lineno">12</span>        """Authenticate user and return user info if valid."""<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="13"><span class="lineno">13</span>        conn = sqlite3.connect(self.db_path)<span class="shap-value" data-value="low">0.09</span></div>
            <div class="code-line" data-lineno="14"><span class="lineno">14</span>        cursor = conn.cursor()<span class="shap-value" data-value="low">0.07</span></div>
            <div class="code-line" data-lineno="15"><span class="lineno">15</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="16"><span class="lineno">16</span>        # Hash the provided password<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="17"><span class="lineno">17</span>        password_hash = hashlib.sha256(password.encode()).hexdig()<span class="shap-value" data-value="medium">0.11</span></div>
            <div class="code-line" data-lineno="18"><span class="lineno">18</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="19"><span class="lineno">19</span>        # Query user from database<span class="shap-value" data-value="low">0.05</span></div>
            <div class="code-line" data-lineno="20"><span class="lineno">20</span>        query = f"SELECT * FROM users WHERE username = '{username}' AND password_hash = '{password_hash}'"<span class="shap-value" data-value="high">0.89</span></div>
            <div class="code-line" data-lineno="21"><span class="lineno">21</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="22"><span class="lineno">22</span>        try:<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="23"><span class="lineno">23</span>            cursor.execute(query)<span class="shap-value" data-value="high">0.67</span></div>
            <div class="code-line" data-lineno="24"><span class="lineno">24</span>            result = cursor.fetchone()<span class="shap-value" data-value="medium">0.15</span></div>
            <div class="code-line" data-lineno="25"><span class="lineno">25</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="26"><span class="lineno">26</span>            if result:<span class="shap-value" data-value="low">0.08</span></div>
            <div class="code-line" data-lineno="27"><span class="lineno">27</span>                return {<span class="shap-value" data-value="low">0.06</span></div>
            <div class="code-line" data-lineno="28"><span class="lineno">28</span>                    'id': result[0],<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="29"><span class="lineno">29</span>                    'username': result[1],<span class="shap-value" data-value="low">0.05</span></div>
            <div class="code-line" data-lineno="30"><span class="lineno">30</span>                    'email': result[3],<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="31"><span class="lineno">31</span>                    'role': result[4]<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="32"><span class="lineno">32</span>                }<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="33"><span class="lineno">33</span>            <span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="34"><span class="lineno">34</span>        except sqlite3.Error as e:<span class="shap-value" data-value="medium">0.12</span></div>
            <div class="code-line" data-lineno="35"><span class="lineno">35</span>            self.logger.error(f"Database error: {e}")<span class="shap-value" data-value="low">0.06</span></div>
            <div class="code-line" data-lineno="36"><span class="lineno">36</span>        finally:<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="37"><span class="lineno">37</span>            conn.close()<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="38"><span class="lineno">38</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="39"><span class="lineno">39</span>        return None<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="40"><span class="lineno">40</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="41"><span class="lineno">41</span>    def get_user_by_id(self, user_id: int) -> Optional[Dict]:<span class="shap-value" data-value="medium">0.14</span></div>
            <div class="code-line" data-lineno="42"><span class="lineno">42</span>        """Retrieve user information by ID."""<span class="shap-value" data-value="low">0.02</span></div>
          </div>
        </div>

        <div id="shapExplanation3" style="display:none;">
          <div class="shap-methodology">
            <h3><i class="fas fa-brain"></i> Security Vulnerability Detection</h3>
            <p><strong>SQL Injection Pattern Recognition:</strong> The model identifies dangerous string concatenation patterns in SQL queries that allow user input to alter query structure.</p>
            <ul>
              <li><strong>Training Data:</strong> 50,000+ code samples with known SQL injection vulnerabilities</li>
              <li><strong>Key Patterns:</strong> String formatting in SQL, lack of parameterized queries</li>
              <li><strong>Risk Assessment:</strong> Direct user input concatenation = Critical Risk</li>
            </ul>
          </div>

          <!-- SHAP Visualization -->
          <div class="shap-visualization">
            <div class="shap-header">
              <h3><i class="fas fa-chart-bar"></i> SQL Injection Risk Analysis</h3>
            </div>
            
            <div class="shap-tabs">
              <div class="shap-tab active" onclick="showShapTab(3, 'force')">Force Plot</div>
              <div class="shap-tab" onclick="showShapTab(3, 'waterfall')">Waterfall</div>
              <div class="shap-tab" onclick="showShapTab(3, 'summary')">Summary</div>
            </div>
            
            <div id="shapForcePlot3" class="shap-graph-container"></div>
            <div id="shapWaterfallPlot3" class="shap-graph-container" style="display:none;"></div>
            <div id="shapSummaryPlot3" class="shap-graph-container" style="display:none;"></div>
            
            <div class="shap-explanation">
              <p><strong>Interpretation:</strong> The force plot highlights how each code line contributes to the SQL injection vulnerability risk. The highest risk lines show in red.</p>
            </div>
          </div>

          <div class="feature-explanation">
            <h4><i class="fas fa-search"></i> Critical Vulnerability Points:</h4>
            <ul>
              <li><strong>Line 20 (0.89):</strong> <span class="accuracy-indicator high-accuracy">CRITICAL</span> Direct string interpolation in SQL query - primary vulnerability</li>
              <li><strong>Line 23 (0.67):</strong> <span class="accuracy-indicator high-accuracy">HIGH RISK</span> Execution of unsafe query enables injection</li>
              <li><strong>Line 1 (0.18):</strong> <span class="accuracy-indicator medium-accuracy">CONTEXT</span> SQLite usage without parameterization</li>
              <li><strong>Line 24 (0.15):</strong> <span class="accuracy-indicator low-accuracy">LOW RISK</span> Result fetching (consequence, not cause)</li>
              <li><strong>Line 11 (0.12):</strong> <span class="accuracy-indicator low-accuracy">LOW RISK</span> Function signature accepting user input</li>
            </ul>
          </div>

          <div class="comparison-panel">
            <h3><i class="fas fa-chart-bar"></i> Developer vs. SHAP Comparison</h3>
            <div class="comparison-row">
              <div class="comparison-card">
                <h4><i class="fas fa-user"></i> Your Initial Assessment</h4>
                <div class="metric">
                  <span>Lines selected:</span>
                  <span class="metric-value" id="preShapLines3">0</span>
                </div>
                <div class="metric">
                  <span>Correct lines:</span>
                  <span class="metric-value" id="preShapCorrect3">0</span>
                </div>
                <div class="metric">
                  <span>Accuracy:</span>
                  <span class="metric-value" id="preShapAccuracy3">0%</span>
                </div>
                <div class="metric">
                  <span>Time taken:</span>
                  <span class="metric-value" id="preShapTime3">0s</span>
                </div>
              </div>
              <div class="comparison-card">
                <h4><i class="fas fa-robot"></i> SHAP Analysis</h4>
                <div class="metric">
                  <span>Critical lines:</span>
                  <span class="metric-value">2</span>
                </div>
                <div class="metric">
                  <span>Overlap with your selection:</span>
                  <span class="metric-value" id="shapOverlap3">0</span>
                </div>
                <div class="metric">
                  <span>Missed critical lines:</span>
                  <span class="metric-value" id="shapMissed3">2</span>
                </div>
                <div class="metric">
                  <span>Average SHAP value:</span>
                  <span class="metric-value" id="shapAvg3">0.00</span>
                </div>
              </div>
            </div>
          </div>

          <div class="insight-prompt">
            <h4><i class="fas fa-lightbulb"></i> Your "Aha!" Moment</h4>
            <p>Did SHAP reveal lines you didn't consider? How did it change your understanding of this bug?</p>
            <textarea id="insight3" placeholder="Write your observations here..."></textarea>
          </div>
        </div>

        <div class="explanation-panel">
          <h3><i class="fas fa-tasks"></i> Your Task</h3>
          <p>Click on the line(s) you believe are most responsible for the SQL injection vulnerability. You can select up to 3 lines.</p>
          <div style="margin:15px 0;">
            <span style="background:#4CAF50;color:white;padding:6px 14px;border-radius:20px;font-size:14px;font-weight:bold;">
              <i class="fas fa-check-circle"></i> Selected: <span id="selectedCount3">0</span>/3
            </span>
          </div>
        </div>

        <div style="margin-top: 30px; text-align: center;">
          <button class="btn btn-primary" id="showShapBtn3">
            <i class="fas fa-chart-line"></i> Show SHAP Analysis
          </button>
          <button class="btn btn-success" id="nextScenarioBtn3" style="display:none;" onclick="loadScenario(4)">
            <i class="fas fa-arrow-right"></i> Next Scenario
          </button>
        </div>
      </div>

      <!-- Scenario 4: Logic Error -->
      <div id="scenario4" class="scenario" style="display:none;">
        <div class="prediction-box">
          <i class="fas fa-brain"></i> Logic Analyzer: MEDIUM RISK - Business logic error detected (Confidence: 71%)
        </div>

        <div class="explanation-panel">
          <h3><i class="fas fa-info-circle"></i> Context</h3>
          <p>This e-commerce pricing system has been generating incorrect discounts. Some customers receive excessive discounts while others get none at all, despite meeting the same criteria. The financial impact is significant.</p>
        </div>

        <div class="code-container">
          <div class="code-header">
            <span>pricing_engine.py</span>
            <span>48 lines</span>
          </div>
          <div class="code" id="code4">
            <div class="code-line" data-lineno="1"><span class="lineno">1</span>from typing import Dict, List<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="2"><span class="lineno">2</span>from datetime import datetime, timedelta<span class="shap-value" data-value="low">0.08</span></div>
            <div class="code-line" data-lineno="3"><span class="lineno">3</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="4"><span class="lineno">4</span>class PricingEngine:<span class="shap-value" data-value="low">0.05</span></div>
            <div class="code-line" data-lineno="5"><span class="lineno">5</span>    def __init__(self):<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="6"><span class="lineno">6</span>        self.loyalty_tiers = {<span class="shap-value" data-value="medium">0.12</span></div>
            <div class="code-line" data-lineno="7"><span class="lineno">7</span>            'bronze': 0.05,<span class="shap-value" data-value="low">0.06</span></div>
            <div class="code-line" data-lineno="8"><span class="lineno">8</span>            'silver': 0.10,<span class="shap-value" data-value="low">0.07</span></div>
            <div class="code-line" data-lineno="9"><span class="lineno">9</span>            'gold': 0.15,<span class="shap-value" data-value="low">0.08</span></div>
            <div class="code-line" data-lineno="10"><span class="lineno">10</span>            'platinum': 0.20<span class="shap-value" data-value="low">0.09</span></div>
            <div class="code-line" data-lineno="11"><span class="lineno">11</span>        }<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="12"><span class="lineno">12</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="13"><span class="lineno">13</span>    def calculate_discount(self, user: Dict, cart_total: float, items: List[Dict]) -> float:<span class="shap-value" data-value="medium">0.15</span></div>
            <div class="code-line" data-lineno="14"><span class="lineno">14</span>        """Calculate total discount for user's cart."""<span class="shap-value" data-value="low">0.02</span></div>
            <div class="code-line" data-lineno="15"><span class="lineno">15</span>        total_discount = 0.0<span class="shap-value" data-value="medium">0.11</span></div>
            <div class="code-line" data-lineno="16"><span class="lineno">16</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="17"><span class="lineno">17</span>        # Apply loyalty discount<span class="shap-value" data-value="low">0.04</span></div>
            <div class="code-line" data-lineno="18"><span class="lineno">18</span>        loyalty_tier = user.get('loyalty_tier', 'bronze')<span class="shap-value" data-value="medium">0.18</span></div>
            <div class="code-line" data-lineno="19"><span class="lineno">19</span>        loyalty_discount = self.loyalty_tiers.get(loyalty_tier, 0.05)<span class="shap-value" data-value="medium">0.22</span></div>
            <div class="code-line" data-lineno="20"><span class="lineno">20</span>        total_discount += cart_total * loyalty_discount<span class="shap-value" data-value="medium">0.31</span></div>
            <div class="code-line" data-lineno="21"><span class="lineno">21</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="22"><span class="lineno">22</span>        # Apply bulk discount (10% off orders over $100)<span class="shap-value" data-value="low">0.06</span></div>
            <div class="code-line" data-lineno="23"><span class="lineno">23</span>        if cart_total > 100:<span class="shap-value" data-value="medium">0.28</span></div>
            <div class="code-line" data-lineno="24"><span class="lineno">24</span>            bulk_discount = cart_total * 0.10<span class="shap-value" data-value="medium">0.35</span></div>
            <div class="code-line" data-lineno="25"><span class="lineno">25</span>            total_discount += bulk_discount<span class="shap-value" data-value="high">0.42</span></div>
            <div class="code-line" data-lineno="26"><span class="lineno">26</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="27"><span class="lineno">27</span>        # Apply first-time customer discount<span class="shap-value" data-value="low">0.05</span></div>
            <div class="code-line" data-lineno="28"><span class="lineno">28</span>        if user.get('is_first_time', False):<span class="shap-value" data-value="medium">0.24</span></div>
            <div class="code-line" data-lineno="29"><span class="lineno">29</span>            first_time_discount = cart_total * 0.15<span class="shap-value" data-value="high">0.39</span></div>
            <div class="code-line" data-lineno="30"><span class="lineno">30</span>            total_discount += first_time_discount<span class="shap-value" data-value="high">0.46</span></div>
            <div class="code-line" data-lineno="31"><span class="lineno">31</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="32"><span class="lineno">32</span>        # Apply seasonal discount if applicable<span class="shap-value" data-value="low">0.07</span></div>
            <div class="code-line" data-lineno="33"><span class="lineno">33</span>        if self._is_holiday_season():<span class="shap-value" data-value="medium">0.26</span></div>
            <div class="code-line" data-lineno="34"><span class="lineno">34</span>            seasonal_discount = cart_total * 0.12<span class="shap-value" data-value="medium">0.33</span></div>
            <div class="code-line" data-lineno="35"><span class="lineno">35</span>            total_discount += seasonal_discount<span class="shap-value" data-value="high">0.41</span></div>
            <div class="code-line" data-lineno="36"><span class="lineno">36</span><span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="37"><span class="lineno">37</span>        return total_discount<span class="shap-value" data-value="medium">0.16</span></div>
            <div class="code-line" data-lineno="38"><span class="lineno">38</span>    <span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="39"><span class="lineno">39</span>    def _is_holiday_season(self) -> bool:<span class="shap-value" data-value="medium">0.19</span></div>
            <div class="code-line" data-lineno="40"><span class="lineno">40</span>        """Check if current date is in holiday season."""<span class="shap-value" data-value="low">0.03</span></div>
            <div class="code-line" data-lineno="41"><span class="lineno">41</span>        now = datetime.now()<span class="shap-value" data-value="medium">0.14</span></div>
            <div class="code-line" data-lineno="42"><span class="lineno">42</span>        # Holiday season: Nov 15 - Jan 15<span class="shap-value" data-value="low">0.08</span></div>
            <div class="code-line" data-lineno="43"><span class="lineno">43</span>        holiday_start = datetime(now.year, 11, 15)<span class="shap-value" data-value="medium">0.12</span></div>
            <div class="code-line" data-lineno="44"><span class="lineno">44</span>        holiday_end = datetime(now.year + 1, 1, 15)<span class="shap-value" data-value="medium">0.13</span></div>
            <div class="code-line" data-lineno="45"><span class="lineno">45</span>        <span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="46"><span class="lineno">46</span>        return holiday_start <= now <= holiday_end<span class="shap-value" data-value="medium">0.21</span></div>
            <div class="code-line" data-lineno="47"><span class="lineno">47</span>    <span class="shap-value" data-value="low">0.00</span></div>
            <div class="code-line" data-lineno="48"><span class="lineno">48</span>    # Additional methods would be here...<span class="shap-value" data-value="low">0.01</span></div>
          </div>
        </div>

        <div id="shapExplanation4" style="display:none;">
          <div class="shap-methodology">
            <h3><i class="fas fa-brain"></i> Business Logic Error Detection</h3>
            <p><strong>Pattern Analysis:</strong> The model identifies discount stacking without limits as a common business logic error that leads to negative profit margins.</p>
            <ul>
              <li><strong>Domain Knowledge:</strong> E-commerce pricing rules and common discount logic errors</li>
              <li><strong>Risk Indicators:</strong> Unlimited discount accumulation, missing validation</li>
              <li><strong>Business Impact:</strong> Financial loss through excessive discount stacking</li>
            </ul>
          </div>

          <!-- SHAP Visualization -->
          <div class="shap-visualization">
            <div class="shap-header">
              <h3><i class="fas fa-chart-bar"></i> Business Logic Risk Analysis</h3>
            </div>
            
            <div class="shap-tabs">
              <div class="shap-tab active" onclick="showShapTab(4, 'force')">Force Plot</div>
              <div class="shap-tab" onclick="showShapTab(4, 'waterfall')">Waterfall</div>
              <div class="shap-tab" onclick="showShapTab(4, 'summary')">Summary</div>
            </div>
            
            <div id="shapForcePlot4" class="shap-graph-container"></div>
            <div id="shapWaterfallPlot4" class="shap-graph-container" style="display:none;"></div>
            <div id="shapSummaryPlot4" class="shap-graph-container" style="display:none;"></div>
            
            <div class="shap-explanation">
              <p><strong>Interpretation:</strong> The force plot shows how each code line contributes to the logic error risk. The highest risk lines are in red, indicating they contribute most to the prediction.</p>
            </div>
          </div>

          <div class="feature-explanation">
            <h4><i class="fas fa-search"></i> Critical Logic Flaws:</h4>
            <ul>
              <li><strong>Line 30 (0.46):</strong> <span class="accuracy-indicator high-accuracy">CRITICAL</span> First-time discount stacks with all others</li>
              <li><strong>Line 25 (0.42):</strong> <span class="accuracy-indicator high-accuracy">HIGH RISK</span> Bulk discount adds without limit checking</li>
              <li><strong>Line 35 (0.41):</strong> <span class="accuracy-indicator high-accuracy">HIGH RISK</span> Seasonal discount compounds the problem</li>
              <li><strong>Line 29 (0.39):</strong> <span class="accuracy-indicator medium-accuracy">MEDIUM RISK</span> High percentage first-time discount</li>
              <li><strong>Line 24 (0.35):</strong> <span class="accuracy-indicator medium-accuracy">MEDIUM RISK</span> Bulk discount calculation</li>
            </ul>
          </div>

          <div class="comparison-panel">
            <h3><i class="fas fa-chart-bar"></i> Developer vs. SHAP Comparison</h3>
            <div class="comparison-row">
              <div class="comparison-card">
                <h4><i class="fas fa-user"></i> Your Initial Assessment</h4>
                <div class="metric">
                  <span>Lines selected:</span>
                  <span class="metric-value" id="preShapLines4">0</span>
                </div>
                <div class="metric">
                  <span>Correct lines:</span>
                  <span class="metric-value" id="preShapCorrect4">0</span>
                </div>
                <div class="metric">
                  <span>Accuracy:</span>
                  <span class="metric-value" id="preShapAccuracy4">0%</span>
                </div>
                <div class="metric">
                  <span>Time taken:</span>
                  <span class="metric-value" id="preShapTime4">0s</span>
                </div>
              </div>
              <div class="comparison-card">
                <h4><i class="fas fa-robot"></i> SHAP Analysis</h4>
                <div class="metric">
                  <span>Critical lines:</span>
                  <span class="metric-value">3</span>
                </div>
                <div class="metric">
                  <span>Overlap with your selection:</span>
                  <span class="metric-value" id="shapOverlap4">0</span>
                </div>
                <div class="metric">
                  <span>Missed critical lines:</span>
                  <span class="metric-value" id="shapMissed4">3</span>
                </div>
                <div class="metric">
                  <span>Average SHAP value:</span>
                  <span class="metric-value" id="shapAvg4">0.00</span>
                </div>
              </div>
            </div>
          </div>

          <div class="insight-prompt">
            <h4><i class="fas fa-lightbulb"></i> Your "Aha!" Moment</h4>
            <p>Did SHAP reveal lines you didn't consider? How did it change your understanding of this bug?</p>
            <textarea id="insight4" placeholder="Write your observations here..."></textarea>
          </div>
        </div>

        <div class="explanation-panel">
          <h3><i class="fas fa-tasks"></i> Your Task</h3>
          <p>Click on the line(s) you believe are most responsible for the excessive discount logic error. You can select up to 3 lines.</p>
          <div style="margin:15px 0;">
            <span style="background:#4CAF50;color:white;padding:6px 14px;border-radius:20px;font-size:14px;font-weight:bold;">
              <i class="fas fa-check-circle"></i> Selected: <span id="selectedCount4">0</span>/3
            </span>
          </div>
        </div>

        <div style="margin-top: 30px; text-align: center;">
          <button class="btn btn-primary" id="showShapBtn4">
            <i class="fas fa-chart-line"></i> Show SHAP Analysis
          </button>
          <button class="btn btn-success" id="submitStudyBtn" style="display:none;">
            <i class="fas fa-check-circle"></i> Complete Study
          </button>
        </div>
      </div>

      <!-- Results Section -->
      <div id="results" style="display:none;">
        <div class="results">
          <h3><i class="fas fa-chart-pie"></i> Study Results Summary</h3>
          <div id="resultData"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === Global Variables ===
    let currentScenario = 1;
    let studyStartTime = new Date();
    let scenarioStartTimes = {1: new Date()};
    
    // Define correct lines for each scenario
    const correctLines = {
      1: [8, 27, 28],   // Memory leak
      2: [12, 13, 19],  // Race condition
      3: [20, 23],      // SQL injection
      4: [25, 30, 35]   // Logic error
    };

    // Keep track of selected lines
    const selectedLines = {1: new Set(), 2: new Set(), 3: new Set(), 4: new Set()};
    
    // Store insights
    const insights = {1: "", 2: "", 3: "", 4: ""};

    // SHAP values
    const shapValues = {
      1: { 8:0.45, 27:0.62, 28:0.38, 10:0.25, 15:0.18, 24:0.11, 7:0.15, 6:0.08, 4:0.03, 1:0.02 },
      2: { 13:0.52, 12:0.41, 19:0.45, 26:0.48, 7:0.31, 10:0.15, 25:0.35, 27:0.33, 37:0.29, 31:0.11 },
      3: { 20:0.89, 23:0.67, 24:0.15, 1:0.18, 11:0.12, 17:0.11, 13:0.09, 14:0.07, 22:0.03, 3:0.03 },
      4: { 30:0.46, 25:0.42, 35:0.41, 29:0.39, 20:0.31, 24:0.35, 34:0.33, 19:0.22, 18:0.18, 23:0.28 }
    };

    // Study data
    const studyData = {
      scenarios: {},
      startTime: studyStartTime,
      userAgent: navigator.userAgent
    };

    // === SHAP Visualization Functions ===
    
    function createShapVisualization(scenario) {
      const shapData = shapValues[scenario];
      const features = Object.keys(shapData);
      const values = Object.values(shapData);
      
      // Create force plot
      const forceData = [{
        type: 'bar',
        x: values,
        y: features.map(f => `Line ${f}`),
        orientation: 'h',
        marker: {
          color: values.map(v => v > 0 ? '#ff6b6b' : '#3498db')
        }
      }];
      
      const forceLayout = {
        title: 'SHAP Feature Impact',
        xaxis: { title: 'SHAP Value (Impact on Prediction)' },
        yaxis: { title: 'Code Line', automargin: true },
        hovermode: 'closest',
        showlegend: false,
        margin: { l: 150, r: 30, t: 50, b: 50 }
      };
      
      Plotly.newPlot(`shapForcePlot${scenario}`, forceData, forceLayout);
      
      // Create waterfall plot
      const sortedFeatures = [...features].sort((a, b) => shapData[b] - shapData[a]);
      const waterfallData = [{
        type: 'waterfall',
        orientation: 'v',
        measure: ['absolute'] // First value is total
          .concat(Array(sortedFeatures.length).fill('relative'))
          .concat(['total']),
        x: ['Base Value'] 
          .concat(sortedFeatures.map(f => `Line ${f}`))
          .concat(['Prediction']),
        textposition: 'outside',
        text: ['0.00']
          .concat(sortedFeatures.map(f => shapData[f].toFixed(3)))
          .concat(['0.78']),
        y: [0] 
          .concat(sortedFeatures.map(f => shapData[f]))
          .concat([0.78]),
        connector: { line: { color: 'rgb(63, 63, 63)' } },
        increasing: { marker: { color: '#ff6b6b' } },
        decreasing: { marker: { color: '#3498db' } },
        totals: { marker: { color: '#2ecc71' } }
      }];
      
      const waterfallLayout = {
        title: 'SHAP Value Contributions',
        xaxis: { type: 'category' },
        yaxis: { title: 'Value Contribution' },
        margin: { t: 50, b: 150 },
        showlegend: false
      };
      
      Plotly.newPlot(`shapWaterfallPlot${scenario}`, waterfallData, waterfallLayout);
      
      // Create summary plot
      const summaryData = [{
        type: 'scatter',
        x: values,
        y: features.map(f => `Line ${f}`),
        mode: 'markers',
        marker: {
          size: values.map(v => Math.abs(v) * 30 + 10),
          color: values.map(v => v > 0 ? '#ff6b6b' : '#3498db'),
          opacity: 0.8
        }
      }];
      
      const summaryLayout = {
        title: 'SHAP Value Summary',
        xaxis: { title: 'SHAP Value' },
        yaxis: { title: 'Code Line', automargin: true },
        margin: { l: 150, r: 30, t: 50, b: 50 }
      };
      
      Plotly.newPlot(`shapSummaryPlot${scenario}`, summaryData, summaryLayout);
    }
    
    function showShapTab(scenario, type) {
      // Update tabs
      const tabs = document.querySelectorAll(`#scenario${scenario} .shap-tab`);
      tabs.forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // Show selected plot
      document.getElementById(`shapForcePlot${scenario}`).style.display = 'none';
      document.getElementById(`shapWaterfallPlot${scenario}`).style.display = 'none';
      document.getElementById(`shapSummaryPlot${scenario}`).style.display = 'none';
      document.getElementById(`shap${type.charAt(0).toUpperCase() + type.slice(1)}Plot${scenario}`).style.display = 'block';
    }
    
    // === Utility Functions ===
    
    // Calculate accuracy before SHAP is shown
    function calculatePreShapAccuracy(scenario) {
      const correctSet = new Set(correctLines[scenario]);
      const selectedSet = selectedLines[scenario];
      
      let correctCount = 0;
      selectedSet.forEach(line => {
        if (correctSet.has(line)) correctCount++;
      });
      
      return {
        selectedCount: selectedSet.size,
        correctCount: correctCount,
        accuracy: correctSet.size > 0 ? Math.round((correctCount / correctSet.size) * 100) : 0
      };
    }
    
    // Update progress bar
    function updateProgressBar() {
      const progress = (currentScenario / 4) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
    }
    
    // Save scenario data
    function saveScenarioData(scenarioNumber) {
      const selectedArray = Array.from(selectedLines[scenarioNumber]);
      const timestamp = new Date();
      
      studyData.scenarios[scenarioNumber] = {
        selectedLines: selectedArray,
        timestamp: timestamp,
        shapValues: shapValues[scenarioNumber],
        insight: insights[scenarioNumber],
        duration: Math.round((timestamp - scenarioStartTimes[scenarioNumber]) / 1000)
      };
    }
    
    // Display results
    function displayResults() {
      // Save final scenario
      saveScenarioData(currentScenario);
      
      // Compute total duration
      studyData.completionTime = new Date();
      studyData.totalDuration = Math.round((studyData.completionTime - studyStartTime) / 1000);
      
      // Calculate overall stats
      let totalCorrect = 0;
      let totalCritical = 0;
      let totalAccuracy = 0;
      let scenarioCount = 0;
      
      for (let i = 1; i <= 4; i++) {
        if (studyData.scenarios[i]) {
          const scenario = studyData.scenarios[i];
          const correctSet = new Set(correctLines[i]);
          const selectedSet = new Set(scenario.selectedLines);
          
          let correctCount = 0;
          selectedSet.forEach(line => {
            if (correctSet.has(line)) correctCount++;
          });
          
          totalCorrect += correctCount;
          totalCritical += correctSet.size;
          totalAccuracy += correctSet.size > 0 ? (correctCount / correctSet.size) : 0;
          scenarioCount++;
        }
      }
      
      const overallAccuracy = scenarioCount > 0 ? Math.round((totalAccuracy / scenarioCount) * 100) : 0;
      
      // Build results HTML
      let html = `
        <div class="stats-row">
          <div class="stat-card">
            <h3>Overall Accuracy</h3>
            <div class="value">${overallAccuracy}%</div>
            <div class="label">across all scenarios</div>
          </div>
          <div class="stat-card">
            <h3>Time Taken</h3>
            <div class="value">${studyData.totalDuration}s</div>
            <div class="label">total study duration</div>
          </div>
          <div class="stat-card">
            <h3>Correct Lines</h3>
            <div class="value">${totalCorrect}/${totalCritical}</div>
            <div class="label">identified correctly</div>
          </div>
        </div>
        
        <h3 style="margin: 30px 0 20px;">Detailed Results</h3>
      `;
      
      for (let i = 1; i <= 4; i++) {
        if (studyData.scenarios[i]) {
          const scenarioInfo = studyData.scenarios[i];
          const selected = scenarioInfo.selectedLines;
          const correctSet = new Set(correctLines[i]);
          const shapVals = scenarioInfo.shapValues;
          
          let correctCount = 0;
          let totalShap = 0;
          
          selected.forEach(line => {
            if (correctSet.has(line)) correctCount++;
            if (shapVals[line]) totalShap += shapVals[line];
          });
          
          const accuracy = correctSet.size > 0 ? Math.round((correctCount / correctSet.size) * 100) : 0;
          const avgShap = selected.length > 0 ? (totalShap / selected.length).toFixed(3) : '0.000';
          
          html += `
            <div class="scenario-result" style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
              <h4>Scenario ${i}: ${getScenarioName(i)}</h4>
              <div style="display: flex; gap: 20px; margin-top: 15px;">
                <div style="flex: 1;">
                  <p><strong>Selected Lines:</strong> ${selected.join(', ') || 'None'}</p>
                  <p><strong>Correct Lines:</strong> ${Array.from(correctSet).join(', ')}</p>
                  <p><strong>Accuracy:</strong> ${accuracy}%</p>
                </div>
                <div style="flex: 1;">
                  <p><strong>Average SHAP Value:</strong> ${avgShap}</p>
                  <p><strong>Time Taken:</strong> ${scenarioInfo.duration}s</p>
                  <p><strong>Insight:</strong> ${scenarioInfo.insight || 'No insight provided'}</p>
                </div>
              </div>
            </div>
          `;
        }
      }
      
      // Add export button
      html += `
        <div class="export-section">
          <button class="btn btn-primary" onclick="exportResults()">
            <i class="fas fa-download"></i> Export Results as JSON
          </button>
          <button class="btn btn-success" onclick="resetStudy()">
            <i class="fas fa-redo"></i> Start Over
          </button>
        </div>
      `;
      
      document.getElementById('resultData').innerHTML = html;
      document.getElementById('results').style.display = 'block';
    }
    
    // Get scenario name
    function getScenarioName(num) {
      const names = {
        1: "Memory Leak",
        2: "Race Condition",
        3: "SQL Injection",
        4: "Logic Error"
      };
      return names[num] || `Scenario ${num}`;
    }
    
    // Export results
    function exportResults() {
      const dataStr = JSON.stringify(studyData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `shap_study_results_${new Date().toISOString().slice(0,10)}.json`;
      link.click();
    }
    
    // Reset study
    function resetStudy() {
      window.location.reload();
    }
    
    // Load scenario
    function loadScenario(n) {
      // Save current scenario data
      if (currentScenario !== n) {
        saveScenarioData(currentScenario);
      }
      
      // Hide all scenarios
      document.querySelectorAll('.scenario').forEach(div => {
        div.style.display = 'none';
      });
      
      // Show target scenario
      document.getElementById(`scenario${n}`).style.display = 'block';
      
      // Update active button
      document.querySelectorAll('.scenario-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.scenario) === n);
      });
      
      // Update selected lines display
      document.getElementById(`selectedCount${n}`).textContent = selectedLines[n].size;
      
      // Update progress bar
      currentScenario = n;
      updateProgressBar();
      
      // Record start time if not already set
      if (!scenarioStartTimes[n]) {
        scenarioStartTimes[n] = new Date();
      }
      
      // Save insight if textarea exists
      const insightEl = document.getElementById(`insight${n}`);
      if (insightEl) {
        insights[n] = insightEl.value;
      }
    }
    
    // Toggle line selection
    function toggleLineSelection(scn, lineNumber, element) {
      const setRef = selectedLines[scn];
      if (setRef.has(lineNumber)) {
        setRef.delete(lineNumber);
        element.classList.remove('selected');
      } else {
        if (setRef.size >= 3) return;
        setRef.add(lineNumber);
        element.classList.add('selected');
      }
      document.getElementById(`selectedCount${scn}`).textContent = setRef.size;
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Set up code line click handlers
      for (let scn = 1; scn <= 4; scn++) {
        const container = document.getElementById(`scenario${scn}`);
        if (!container) continue;
        
        const lines = container.querySelectorAll('.code-line');
        lines.forEach(lineEl => {
          const ln = parseInt(lineEl.dataset.lineno, 10);
          lineEl.addEventListener('click', () => {
            toggleLineSelection(scn, ln, lineEl);
          });
        });
      }
      
      // Set up SHAP button for scenario 1
      document.getElementById('showShapBtn1').addEventListener('click', () => {
        handleShapButtonClick(1);
      });
      
      // Set up SHAP button for scenario 2
      document.getElementById('showShapBtn2').addEventListener('click', () => {
        handleShapButtonClick(2);
      });
      
      // Set up SHAP button for scenario 3
      document.getElementById('showShapBtn3').addEventListener('click', () => {
        handleShapButtonClick(3);
      });
      
      // Set up SHAP button for scenario 4
      document.getElementById('showShapBtn4').addEventListener('click', () => {
        handleShapButtonClick(4);
      });
      
      // Set up submit button
      document.getElementById('submitStudyBtn').addEventListener('click', () => {
        displayResults();
      });
      
      // Set initial progress bar
      updateProgressBar();
    });
    
    function handleShapButtonClick(scenario) {
      // Calculate time taken
      const timeTaken = Math.round((new Date() - scenarioStartTimes[scenario]) / 1000);
      
      // Calculate pre-SHAP accuracy
      const accuracyData = calculatePreShapAccuracy(scenario);
      
      // Calculate comparison metrics
      const selectedSet = selectedLines[scenario];
      const correctSet = new Set(correctLines[scenario]);
      let overlap = 0;
      let totalShap = 0;
      
      selectedSet.forEach(line => {
        if (correctSet.has(line)) overlap++;
        if (shapValues[scenario][line]) totalShap += shapValues[scenario][line];
      });
      
      const avgShap = selectedSet.size > 0 ? (totalShap / selectedSet.size).toFixed(3) : '0.000';
      
      // Update comparison panel
      document.getElementById(`preShapLines${scenario}`).textContent = accuracyData.selectedCount;
      document.getElementById(`preShapCorrect${scenario}`).textContent = accuracyData.correctCount;
      document.getElementById(`preShapAccuracy${scenario}`).textContent = `${accuracyData.accuracy}%`;
      document.getElementById(`preShapTime${scenario}`).textContent = `${timeTaken}s`;
      document.getElementById(`shapOverlap${scenario}`).textContent = overlap;
      document.getElementById(`shapMissed${scenario}`).textContent = correctSet.size - overlap;
      document.getElementById(`shapAvg${scenario}`).textContent = avgShap;
      
      // Show SHAP explanation
      document.getElementById(`shapExplanation${scenario}`).style.display = 'block';
      
      // Show next button for scenarios 1-3, submit button for scenario 4
      if (scenario < 4) {
        document.getElementById(`nextScenarioBtn${scenario}`).style.display = 'inline-block';
      } else {
        document.getElementById('submitStudyBtn').style.display = 'inline-block';
      }
      
      // Auto-show SHAP values
      document.getElementById(`scenario${scenario}`).classList.add('show-shap');
      
      // Create SHAP visualization
      createShapVisualization(scenario);
    }
  </script>
  
  <!-- Font Awesome for icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>